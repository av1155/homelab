name: CI - Validate Docker Compose & YAML

on:
    push:
        branches:
            - "main"
    pull_request:
        branches:
            - "main"

jobs:
    validate:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repo
              uses: actions/checkout@v4

            # Install dependencies
            - name: Install Docker
              uses: docker/setup-buildx-action@v3

            - name: Install yamllint
              run: sudo apt-get update && sudo apt-get install -y yamllint

            # Check YAML formatting
            - name: Lint YAML files
              run: yamllint .

            # Validate docker-compose files
            - name: Validate Docker Compose files
              run: |
                  find stacks -name "docker-compose.yaml" -print0 | while IFS= read -r -d '' f; do
                    echo "Validating $f"
                    docker compose -f "$f" config --no-interpolate >/dev/null
                  done

            # Install trufflehog
            - name: Install trufflehog
              run: |
                  curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/v3.83.7/scripts/install.sh | sh

            # Secret scanning (fail on findings)
            - name: Scan for secrets
              run: ./trufflehog filesystem --no-update --fail stacks
